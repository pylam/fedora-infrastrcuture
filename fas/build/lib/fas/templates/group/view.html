<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
  xmlns:py="http://genshi.edgewall.org/"
  xmlns:xi="http://www.w3.org/2001/XInclude">
  <xi:include href="../master.html" />
  <head>
    <title>${_('View Group')}</title>
  </head>
  <body>
    <?python
    from fas import auth
    from fas.model import People
    import pytz
    person = People.by_username(tg.identity.user.username)
    timezone = pytz.timezone(person.timezone)
    can_admin = auth.canAdminGroup(person, group)
    can_sponsor = auth.canSponsorGroup(person, group)
    ?>
    <h2>${group.display_name} (${group.name})</h2>
    <h3>
      ${_('My Status:')}
      <span py:if="group in person.memberships and group in person.approved_memberships" class="approved">${_('Approved')}</span>
      <span py:if="group in person.memberships and not group in person.approved_memberships" class="unapproved">${_('Unapproved')}</span>
      <span py:if="not group in person.memberships">${_('Not a Member')}</span>
    </h3>
    <form py:if="not group in person.memberships" action="${tg.url('/group/apply/%s/%s' % (group.name, person.username))}">
      <div>
        <!--<input type="text" name="requestField" value="${_('Please let me join...')}" />-->
        <input type="submit" value="${('Apply!')}" />
      </div>
    </form>
    <a py:if="group in person.memberships" href="${tg.url('/group/remove/%s/%s' % (group.name, person.username))}">${_('Remove me')}</a>
    <script py:if="group in person.memberships" type="text/javascript">var hb7 = new HelpBalloon({dataURL: '${tg.url('/help/get_help/group_remove')}'});</script>
    <h3>Group Details <a py:if="can_admin" href="${tg.url('/group/edit/%s' % group.name)}">${_('(edit)')}</a></h3>
    <div class="userbox">
      <dl>
        <dt>${_('Name:')}</dt><dd>${group.name}&nbsp;</dd>
        <dt>${_('Description:')}</dt><dd>${group.display_name}&nbsp;</dd>
        <dt>${_('Owner:')}</dt><dd>${group.owner.username}&nbsp;</dd>
        <dt>${_('Type:')}</dt><dd>${group.group_type}&nbsp;</dd>
        <dt>${_('Needs Sponsor:')}</dt><dd>
        <py:if test="group.needs_sponsor">${_('Yes')}</py:if>
        <py:if test="not group.needs_sponsor">${_('No')}</py:if>
        &nbsp;</dd>
        <dt>${_('Self Removal:')}</dt><dd>
        <py:if test="group.user_can_remove">${_('Yes')}</py:if>
        <py:if test="not group.user_can_remove">${_('No')}</py:if>
        &nbsp;</dd>
        <dt>${_('Join Message:')}</dt><dd>${group.joinmsg}&nbsp;</dd>
        <dt>${_('Prerequisite:')}</dt>
            <dd py:if="group.prerequisite">${group.prerequisite.name}&nbsp;</dd>
            <dd py:if="not group.prerequisite">&nbsp;</dd>
        <dt>${_('Created:')}</dt><dd>${group.creation}&nbsp;</dd>
        <py:if test="can_sponsor">
        <dt>${_('Add User:')}</dt>
        <dd>
          <form action="${tg.url('/group/apply/%s' % group.name)}">
            <input type='text' size='15' name='targetname'/>
            <input type="submit" value="${('Add')}" />
            <script type="text/javascript">var group_user_add = new HelpBalloon({dataURL: '${tg.url('/help/get_help/group_user_add')}'});</script>
          </form>
        </dd>
        </py:if>
      </dl>
    </div>
    <!--
    TODO: Implement this :)
    <h3 py:if='me.fedoraRoleStatus == "approved"'>${_('Invite')}</h3>
    <span py:if='me.fedoraRoleStatus == "approved"'>${form(action='modifyGroup', value=value, method='get')}</span>
    -->
    <h3>${_('Members')}</h3>
    <table>
      <thead>
        <tr>
          <th>${_('Username')}</th>
          <th>${_('Sponsor')}</th>
          <th>${_('Date Added')}</th>
          <th>${_('Date Approved')}</th>
          <th>${_('Approval')}</th>
          <th>${_('Role Type')}</th>
          <th py:if="can_sponsor">${_('Action')}</th>
        </tr>
      </thead>
      <tr py:for="role in sorted([(role.member.username, role) for role in group.roles ])">
        <td><a href="${tg.url('/user/view/%s' % role[1].member.username)}">${role[1].member.username}</a></td>
        <td py:if='role[1].sponsor'><a href="${tg.url('/user/view/%s' % role[1].sponsor.username)}">${role[1].sponsor.username}</a></td>
        <td py:if='not role[1].sponsor'>${_('None')}</td>
        <td>${role[1].creation.astimezone(timezone).strftime('%Y-%m-%d %H:%M:%S %Z')}</td>
        <td py:if='role[1].approval'>${role[1].approval.astimezone(timezone).strftime('%Y-%m-%d %H:%M:%S %Z')}</td>
        <td py:if='not role[1].approval'>${_('None')}</td>
        <td>${role[1].role_status}</td>
        <td>${role[1].role_type}</td>
        <!-- This section includes all action items -->
        <td py:if="can_sponsor">
          <ul class="actions">
            <li py:if="role[1].role_status == 'unapproved'">
            <py:if test="group.needs_sponsor">
            <a href="${tg.url('/group/sponsor/%s/%s' % (group.name, role[1].member.username))}">${_('Sponsor')}</a>
            <script type="text/javascript">var hb1 = new HelpBalloon({dataURL: '${tg.url('/help/get_help/group_sponsor')}'});</script>
            </py:if>
            <py:if test="not group.needs_sponsor">
            <a href="${tg.url('/group/sponsor/%s/%s' % (group.name, role[1].member.username))}">${_('Approve')}</a>
            <script type="text/javascript">var hb2 = new HelpBalloon({dataURL: '${tg.url('/help/get_help/group_approve')}'});</script>
            </py:if>
            </li>
            <li>
            <a href="${tg.url('/group/remove/%s/%s' % (group.name, role[1].member.username))}">${_('Remove')}</a>
            <script type="text/javascript">var hb3 = new HelpBalloon({dataURL: '${tg.url('/help/get_help/group_remove')}'});</script>
            </li>
            <li py:if="role[1].role_type != 'administrator' or auth.canDowngradeUser(person, group, role[1].member)">
            <a href="${tg.url('/group/upgrade/%s/%s' % (group.name, role[1].member.username))}">${_('Upgrade')}</a>
            <script type="text/javascript">var hb4 = new HelpBalloon({dataURL: '${tg.url('/help/get_help/group_upgrade')}'});</script>
            </li>
            <li py:if="role[1].role_type != 'user' or auth.canDowngradeUser(person, group, role[1].member)">
            <a href="${tg.url('/group/downgrade/%s/%s' % (group.name, role[1].member.username))}">${_('Downgrade')}</a>
            <script type="text/javascript">var hb5 = new HelpBalloon({dataURL: '${tg.url('/help/get_help/group_downgrade')}'});</script>
            </li>
          </ul>
        </td>
      </tr>
    </table>
  </body>
</html>
